' Gambas class file

Public MC As New MainClass
Public ObjRes As Result

Public CatalogsID As New Integer[]
Public GroupsID As New Integer[]
Public SubGroupsID As New Integer[]
Public PointsID As New Integer[]

Public OLD As String
Public TitleOld As String

Public AttachStatus As String = "none"


Public Function Refresh()
    
    Dim i As Integer
    
    CmbPoints.Clear()
    PointsID.Clear()
    
    ObjRes = mc.CConnection().Exec("select id,title from points where subgroups_id=" & SubGroupsID[CmbSubgroups.Index])
    
    For i = 1 To ObjRes.Count
        
        PointsID.Add(ObjRes!id)
        CmbPoints.Add(ObjRes!title)
        ObjRes.MoveNext()
        
    Next
    
    If CmbPoints.Count = 0 Then
        
        TxtPoint.Enabled = False
        TxtDescription.Enabled = False
        BtnEdit.Enabled = False
        BtnDel.Enabled = False
        PnlTextFormat.Enabled = False
        TxtPoint.Text = ""
        TxtDescription.Text = ""
        
    Else
        
        CmbPoints.Index = 0
        TxtPoint.Text = CmbPoints.Text
        OLD = CmbPoints.Text
        
        TitleFill()
        TxtPoint.Enabled = True
        TxtDescription.Enabled = True
        BtnEdit.Enabled = True
        BtnDel.Enabled = True
        PnlTextFormat.Enabled = True
        
    Endif   
    
End

Public Function TitleFill()
    
    ObjRes = mc.CConnection().Exec("select description,attach_file from points where id=" & PointsID[CmbPoints.Index])

    TxtDescription.RichText = ObjRes!description
    TitleOld = ObjRes!description
    AttachStatus = "none"
    If ObjRes!attach_file == "no_attach" Then
        LblAttach.Text = "ضمیمه‌ای افزوده نشده است"
        BtnDelAttach.Visible = False
        BtnOpenAttach.Visible = False
    Else
        LblAttach.Text = ObjRes!attach_file
        BtnDelAttach.Visible = True
        BtnOpenAttach.Visible = True
    Endif
    
    'Message(Description)
    
End



Public Sub Form_Open()
    
    Dim i As Integer
    Dim StrFont As String

    Me.Center()
    
    
    For Each StrFont In Fonts
        CmbFont.Add(StrFont)
    Next
    
    
    ObjRes = mc.CConnection().Exec("select id,catalogname  from catalogs")
    
    
    For i = 1 To ObjRes.Count
        CatalogsID.Add(ObjRes!id)
        Cmbcatalogs.Add(ObjRes!catalogname)
        ObjRes.MoveNext()
    Next
    
    If Cmbcatalogs.Count = 0 Then
        
        Panel1.Enabled = False
        TxtDescription.Enabled = False
        BtnEdit.Enabled = False
        BtnDel.Enabled = False
        PnlTextFormat.Enabled = False
        
        
    Else
        
        Panel1.Enabled = True
        TxtDescription.Enabled = True
        BtnEdit.Enabled = True
        BtnDel.Enabled = True
        PnlTextFormat.Enabled = True
        
        CmbCatalogs_Click()
        
    Endif
    

End

Public Sub BtnExit_Click()

    Me.Close

End

Public Sub CmbCatalogs_Click()

    Dim i As Integer
    
    Cmbgroups.Clear()
    GroupsID.Clear()
    
    ObjRes = mc.CConnection().Exec("select id,groupname from groups where catalogs_id=" & CatalogsID[Cmbcatalogs.Index])
    
    For i = 1 To ObjRes.Count
        
        GroupsID.Add(ObjRes!id)
        Cmbgroups.Add(ObjRes!groupname)
        ObjRes.MoveNext()
        
    Next
    
    If Cmbgroups.Count = 0 Then
        
        CmbPoints.Enabled = False
        Cmbgroups.Enabled = False
        TxtPoint.Enabled = False
        TxtDescription.Enabled = False
        CmbSubGroups.Enabled = False
        BtnEdit.Enabled = False
        BtnDel.Enabled = False
        PnlTextFormat.Enabled = False
        
        CmbSubgroups.Clear()
        CmbPoints.Clear()
        TxtPoint.Text = ""
        TxtDescription.Text = ""
        
    Else
        
        CmbPoints.Enabled = True
        Cmbgroups.Enabled = True
        CmbSubGroups.Enabled = True
        TxtPoint.Enabled = True
        TxtDescription.Enabled = True
        BtnEdit.Enabled = True
        BtnDel.Enabled = True
        PnlTextFormat.Enabled = True
        
        
        CmbGroups_Click()
        
    Endif

End

Public Sub CmbGroups_Click()

    Dim i As Integer
    
    CmbSubGroups.Clear()
    SubGroupsID.Clear()
    
    ObjRes = mc.CConnection().Exec("select id,subgroupname from subgroups where groups_id=" & GroupsID[CmbGroups.Index])
    
    For i = 1 To ObjRes.Count
        
        SubGroupsID.Add(ObjRes!id)
        CmbSubgroups.Add(ObjRes!subgroupname)
        ObjRes.MoveNext()
        
    Next
    
    If CmbSubgroups.Count = 0 Then
        
        'Cmbgroups.Enabled = False
        TxtPoint.Enabled = False
        TxtDescription.Enabled = False
        BtnEdit.Enabled = False
        BtnDel.Enabled = False
        PnlTextFormat.Enabled = False
        TxtPoint.Text = ""
        TxtDescription.Text = ""
        
    Else
        'TxtSubGroups.Text = CmbSubGroups.Text
        'OLD = CmbSubGroups.Text
        'Cmbgroups.Enabled = True
        'Refresh()
        TxtPoint.Enabled = True
        TxtDescription.Enabled = True
        BtnEdit.Enabled = True
        BtnDel.Enabled = True
        PnlTextFormat.Enabled = True
        
        Refresh()
        
    Endif  

End

Public Sub CmbSubGroups_Click()

    Refresh()

End

Public Sub BtnEdit_Click()
    Dim RSpace As String
    Dim Description As String
    
    Description = TxtDescription.RichText
    Description = Replace(Description, "'", "''")
    
    RSpace = LTrim(RTrim(TxtPoint.Text))
    
    If TxtPoint.Text And TxtDescription.Text Then
        
        If TxtPoint.Text <> OLD Then
            
            ObjRes = mc.CConnection().Exec("select count(id) as count from points where lower(title)='" & Lower(RSpace) & "' and subgroups_id=" & SubGroupsID[CmbSubgroups.Index])
            
            If CInt(ObjRes!count) = 0 Then
                
                mc.CConnection().Exec("update points set title='" & TxtPoint.Text & "',description='" & Description & "' where id=" & PointsID[CmbPoints.Index])
                Refresh()
                
            Else
                Message("نام نکته تکراری است")
            Endif
            
        Else
            
            If TitleOld <> TxtDescription.RichText Then
                
                mc.CConnection().Exec("update points set description='" & Description & "' where id=" & PointsID[CmbPoints.Index])
                Refresh()
                
            Endif
         
        Endif
        
    Else
        
        Message("لطفا نام نکته و/یا متن نکته را وارد کنید")
        
    Endif
    
    Print AttachStatus
    
    If AttachStatus <> "none" Then
        
        If AttachStatus == "new" Then
            If Exist(user.Home & "/.Points/DB/AttachFiles/" & PointsID[CmbPoints.Index] & ".zip") Then
                Kill user.Home & "/.Points/DB/AttachFiles/" & PointsID[CmbPoints.Index] & ".zip"
            Endif
                
                Shell "cd '" & file.Dir(LblAttach.Text) & "';" & " zip " & user.Home & "/.Points/DB/AttachFiles/" & PointsID[CmbPoints.Index] & ".zip " & "'" & file.Name(LblAttach.Text) & "'"
                mc.CConnection().Exec("update points set attach_file='" & file.Name(LblAttach.Text) & "' where id=" & PointsID[CmbPoints.Index])
                AttachStatus = "none"
                Refresh()
                
        Endif
        
        If AttachStatus == "del" Then
             If Exist(user.Home & "/.Points/DB/AttachFiles/" & PointsID[CmbPoints.Index] & ".zip") Then
                Kill user.Home & "/.Points/DB/AttachFiles/" & PointsID[CmbPoints.Index] & ".zip"
            Endif
            
            mc.CConnection().Exec("update points set attach_file='no_attach' where id=" & PointsID[CmbPoints.Index])
            AttachStatus = "none"
            Refresh()
            
        Endif
        
    Endif

End

Public Sub BtnDel_Click()

    If Message.Question("ایا مطمئن هستید", "بلی", "خیر") = 1 Then
        
        mc.CConnection().Exec("delete from points where id=" & PointsID[CmbPoints.Index])
        Refresh()
        
    Endif

End

Public Sub CmbPoints_Click()
    
    TxtPoint.Text = CmbPoints.Text
    OLD = CmbPoints.Text
    
    TitleFill()

End

Public Sub TxtDescription_Cursor()

    Object.Lock(TBtnBold)
    Object.Lock(TBtnCenterAlign)
    Object.Lock(TBtnItalic)
    Object.Lock(TBtnLeftAlign)
    Object.Lock(TBtnRightAlign)
    Object.Lock(TBtnStrike)
    Object.Lock(TBtnUnderline)
    Object.Lock(ClrBtnColor)
    Object.Lock(ClrBtnBackColor)
    Object.Lock(CmbFont)
    Object.Lock(SpnSize)


    TBtnBold.Value = TxtDescription.Format.Font.Bold
    TBtnItalic.Value = TxtDescription.Format.Font.Italic
    TBtnUnderline.Value = TxtDescription.Format.Font.Underline
    TBtnStrike.Value = TxtDescription.Format.Font.Strikeout
    
    
    Select Case TxtDescription.Format.Alignment 
        Case Align.Left
            TBtnLeftAlign.Value = True
        Case Align.Center
            TBtnCenterAlign.Value = True
        Case Align.Right
            TBtnRightAlign.Value = True
        Case Align.Normal
            TBtnLeftAlign.Value = True
    End Select
    
    
    CmbFont.Text = TxtDescription.Format.Font.Name
    SpnSize.Value = TxtDescription.Format.Font.Size
    ClrBtnColor.Color = TxtDescription.Format.Color
    ClrBtnBackColor.Color = TxtDescription.Format.Background
    
    
    Object.Unlock(TBtnBold)
    Object.Unlock(TBtnCenterAlign)
    Object.Unlock(TBtnItalic)
    Object.Unlock(TBtnLeftAlign)
    Object.Unlock(TBtnRightAlign)
    Object.Unlock(TBtnStrike)
    Object.Unlock(TBtnUnderline)
    Object.Unlock(ClrBtnColor)
    Object.Unlock(ClrBtnBackColor)
    Object.Unlock(CmbFont)
    Object.Unlock(SpnSize)

End

Public Sub TBtnBold_Click()

    TxtDescription.Format.Font.Bold = Last.Value

End

Public Sub TBtnItalic_Click()

    TxtDescription.Format.Font.Italic = Last.Value

End

Public Sub TBtnUnderline_Click()

    TxtDescription.Format.Font.Underline = Last.Value

End

Public Sub TBtnStrike_Click()

    TxtDescription.Format.Font.Strikeout = Last.Value

End

Public Sub TBtnLeftAlign_Click()

    TxtDescription.Format.Alignment = Align.Left

End

Public Sub TBtnCenterAlign_Click()

    TxtDescription.Format.Alignment = Align.Center

End

Public Sub TBtnRightAlign_Click()

    TxtDescription.Format.Alignment = Align.Right

End


Public Sub CmbFont_Click()

    TxtDescription.Format.Font.Name = Last.Text

End

Public Sub SpnSize_Change()

    TxtDescription.Format.Font.Size = Last.Text

End

Public Sub ClrBtnColor_Change()

    TxtDescription.Format.Color = ClrBtnColor.Color

End

Public Sub ClrBtnBackColor_Change()

    TxtDescription.Format.Background = ClrBtnBackColor.Color

End

Public Sub BtnOpenAttach_Click()

    Dim Attach As String
    Attach = PointsID[CmbPoints.Index]
    'Message.Info(Attach)
    If Exist(user.Home & "/.Points/DB/AttachFiles/" & Attach & ".zip") Then
        
        If Exist("/tmp/Points") Then
            Shell "rm -rf /tmp/Points/*.*"
            'Shell "mkdir /tmp/Points"
            'Message.Info("Deleted.")
        Else
            Shell "mkdir /tmp/Points"
        Endif
        
        Shell "unzip '" & user.Home & "/.Points/DB/AttachFiles/" & Attach & "' -d /tmp/Points"
        Shell " nautilus /tmp/Points/"
    Else
        Shell "nautilus '" & LblAttach.Text & "'"
    Endif

End

Public Sub BtnAttach_Click()

     If Dialog.OpenFile() Then
        'LblAttach.Text = "ضمیمه‌ای افزوده نشده است"
    Else
        LblAttach.Text = Dialog.Path
        LblAttach.Tooltip = file.Name(Dialog.Path)
        BtnDelAttach.Visible = True
        BtnOpenAttach.Visible = True
        AttachStatus = "new"
        'TglBtnCompress.Visible = True
    Endif

End

Public Sub BtnDelAttach_Click()

    LblAttach.Text = "ضمیمه‌ای افزوده نشده است"
    BtnOpenAttach.Visible = False
    BtnDelAttach.Visible = False
    AttachStatus = "del"

End
