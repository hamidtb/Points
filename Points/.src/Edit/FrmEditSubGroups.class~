' Gambas class file

Public MC As New MainClass
Public ObjRes As Result

Public CatalogsID As New Integer[]
Public GroupsID As New Integer[]
Public SubGroupsID As New Integer[]

Public OLD As String

Public Function Refresh()
    
  Dim i As Integer
    
    CmbSubGroups.Clear()
    SubGroupsID.Clear()
    
    ObjRes = mc.CConnection().Exec("select id,subgroupname from subgroups where groups_id=" & GroupsID[CmbGroups.Index])
    
    For i = 1 To ObjRes.Count
        
        SubGroupsID.Add(ObjRes!id)
        CmbSubgroups.Add(ObjRes!subgroupname)
        ObjRes.MoveNext()
        
    Next
    
    If CmbSubgroups.Count = 0 Then
        
        'Cmbgroups.Enabled = False
        TxtSubGroups.Enabled = False
        BtnEdit.Enabled = False
        BtnDel.Enabled = False
        TxtSubGroups.Text = ""
        
    Else
        TxtSubGroups.Text = CmbSubGroups.Text
        OLD = CmbSubGroups.Text
        'Cmbgroups.Enabled = True
        TxtSubGroups.Enabled = True
        BtnEdit.Enabled = True
        BtnDel.Enabled = True
        
    Endif  
    
End


Public Sub Form_Open()
    
    Dim i As Integer
    
    Me.Center()
    
    ObjRes = mc.CConnection().Exec("select id,catalogname  from catalogs")
    
    
    For i = 1 To ObjRes.Count
        CatalogsID.Add(ObjRes!id)
        Cmbcatalogs.Add(ObjRes!catalogname)
        ObjRes.MoveNext()
    Next
    
    If ObjRes.Count = 0 Then
        
        Panel1.Enabled = False
        BtnEdit.Enabled = False
        BtnDel.Enabled = False
        
        
    Else
        
        CmbCatalogs_Click()
        Panel1.Enabled = True
        BtnEdit.Enabled = True
        BtnDel.Enabled = True
        
    Endif

End

Public Sub BtnExit_Click()

    Me.Close()

End

Public Sub CmbCatalogs_Click()

    Dim i As Integer
    
    Cmbgroups.Clear()
    GroupsID.Clear()
    
    ObjRes = mc.CConnection().Exec("select id,groupname from groups where catalogs_id=" & CatalogsID[Cmbcatalogs.Index])
    
    For i = 1 To ObjRes.Count
        
        GroupsID.Add(ObjRes!id)
        Cmbgroups.Add(ObjRes!groupname)
        ObjRes.MoveNext()
        
    Next
    
    If Cmbgroups.Count = 0 Then
        
        Cmbgroups.Enabled = False
        TxtSubGroups.Enabled = False
        CmbSubGroups.Enabled = False
        BtnEdit.Enabled = False
        BtnDel.Enabled = False
        
    Else
        
        Cmbgroups.Enabled = True
        CmbSubGroups.Enabled = True
        TxtSubGroups.Enabled = True
        BtnEdit.Enabled = True
        BtnDel.Enabled = True
        
        Refresh()
        
    Endif

End

Public Sub CmbGroups_Click()

    Refresh()

End

Public Sub BtnEdit_Click()

Dim RSpace As String
    
    RSpace = LTrim(RTrim(TxtSubGroups.Text))
    If TxtSubGroups.Text Then
        
        If OLD <> TxtSubGroups.Text Then
           ObjRes = mc.CConnection().Exec("select count(id) as count from subgroups where lower(subgroupname)='" & Lower(RSpace) & "' and groups_id=" & GroupsID[CmbGroups.Index])
            If CInt(ObjRes!count) = 0 Then
                
                mc.CConnection().Exec("update subgroups set subgroupname='" & RSpace & "' where id=" & SubGroupsID[CmbSubGroups.Index])
                Refresh()
                
            Else
                
                Message("نام زیرگروه تکراری است")
                
            Endif
        Endif
    Else
        
        Message("لطفا نام زیرگروه را وارد کنید")
        
    Endif

End

Public Sub CmbSubGroups_Click()

    TxtSubGroups.Text = CmbSubGroups.Text
    OLD = TxtSubGroups.Text

End

Public Sub BtnDel_Click()

    If Message.Question("ایا مطمئن هستید", "بلی", "خیر") = 1 Then
        
        ObjRes = mc.CConnection().Exec("select count(id) as count from points where subgroups_id=" & SubGroupsID[CmbSubGroups.Index])
        
        If CInt(ObjRes!count) = 0 Then
            
            mc.CConnection().Exec("delete from subgroups where id=" & SubGroupsID[CmbSubGroups.Index])
            Refresh()
            
        Else
            Message.Error("این زیرگروه شامل زیر مجموعه میباشد\n سیستم قادر به پاکسازی نیست")
        Endif
        
    Endif

End
