' Gambas class file

Public CatalogID As New Integer[]
Public GroupID As New Integer[]

Public Sub Form_Show()

Dim ObjRes As Result
Dim MC As New MainClass

Dim i As Integer
    Me.Center()
    
    MC.CConnection().Open
    ObjRes = MC.CConnection().Exec("select id,catalogname from catalogs")
    
    If ObjRes.Count > 0 Then
    
        For i = 1 To ObjRes.Count 
            
            Cmbcatalog.Add(ObjRes!catalogname)
            CatalogID.Add(ObjRes!id)
            ObjRes.MoveNext()
        Next
        Cmbcatalog_Change()
    Else
        Frame1.Enabled = False
        BtnAdd.Enabled = False    
        Message("هنوز هیچ دسته ای ثبت نشده است")
    Endif
    
    mc.CConnection().Close()

End

Public Sub BtnExit_Click()
    
    Me.Close()
    

End

Public Sub Cmbcatalog_Change()

    Dim MC As New MainClass
    Dim ObjRes As Result
    Dim i, ii As Integer
    
    mc.CConnection().Open()
    GroupID.Clear()
    
    ObjRes = mc.CConnection().Exec("select  id,groupname  from groups where catalogs_id=" & CatalogID[Cmbcatalog.Index])
    
    'Message("select  id,groupname  from groups where catalog_id=" & Cmbcatalog.Index)
    CmbGroup.Clear()
    If ObjRes.Count > 0 Then
        For i = 1 To ObjRes.Count
            CmbGroup.Add(ObjRes!groupname)
            GroupID.Add(ObjRes!id)
            ObjRes.MoveNext()
        Next
        
        ' For Each ii In GroupID
        '     Message(ii)
        ' Next
        Label2.Enabled = True
        Label3.Enabled = True
        CmbGroup.Enabled = True
        TxtSubgroup.Enabled = True
        BtnAdd.Enabled = True    
    Else
        Label2.Enabled = False
        Label3.Enabled = False
        CmbGroup.Enabled = False
        TxtSubgroup.Enabled = False
        BtnAdd.Enabled = False    
        'Message("هنوز هیچ گروهی نشده است")
    Endif
mc.CConnection().Close()
End

Public Sub Cmbcatalog_Click()

    Cmbcatalog_Change()

End

Public Sub BtnAdd_Click()

    Dim mc As New MainClass
    Dim ObjRes As Result
    Dim MaxID, Count As Integer
    
    mc.CConnection().Open()
    
    ObjRes = mc.CConnection().Exec("select count (id) as Count from subgroups where subgroupname='" & TxtSubgroup.Text & "'")
    
    Count = ObjRes!Count
    If TxtSubgroup.Text Then
        
        If Count = 0 Then
            
            ObjRes = mc.CConnection().Exec("select max(id) as MaxID from subgroups")
            Try MaxID = ObjRes!MaxID
            If Error Then
                MaxID = 0
            Endif
            
            MaxID += 1
            
           ' Message(MaxID)
            Message("insert into subgroups(id,groups_id,subgroupname) values(" & MaxID & "," & GroupID[CmbGroup.Index] & ",'" & TxtSubgroup.Text & "')")
            mc.CConnection().Exec("insert into subgroups(id,groups_id,subgroupname) values(" & MaxID & "," & GroupID[CmbGroup.Index] & ",'" & TxtSubgroup.Text & "')")
            TxtSubgroup.Clear()
            
        Else
            
            Message("نام زیرگروه تکراری است")
                
        Endif
    Else
        Message("لطفا نام زیرگروه را وارد کنید")
    Endif

End

Public Sub Form_Open()

    

End
